name: Continuous Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
        - staging
        - production

jobs:
  # First, run all the tests
  test:
    uses: ./.github/workflows/reusable-tests.yml

  # Deploy to staging automatically
  deploy-staging:
    runs-on: ubuntu-latest
    needs: test
    if: github.event.inputs.environment == 'staging'
    environment:
      name: staging
      url: https://staging.example.com # Placeholder
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Deploy to staging
        run: |
          echo "üöÄ Deploying to staging..."
          # In a real scenario, this would be a script that connects to your staging server
          # and runs `docker-compose up -d` or similar.
          # For now, this is a placeholder.
          echo "‚úÖ Deployed to staging."

  # Deploy to production requires manual approval
  deploy-production:
    runs-on: ubuntu-latest
    needs: test
    if: github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://production.example.com # Placeholder
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Deploy to production
        run: |
          echo "üöÄ Deploying to production..."
          # This step will only run after manual approval.
          # The approval is configured in the repository settings for the 'production' environment.
          # You need to create an environment called 'production' and add a 'Required reviewers' protection rule.
          echo "‚úÖ Deployed to production."

  # After deployment, run smoke tests
  smoke-test:
    runs-on: ubuntu-latest
    needs: [deploy-staging, deploy-production]
    if: success() # Only run if deployment was successful
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name of project
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose
          docker-compose -f docker-compose.yml up -d
          # Give services time to start
          sleep 30
      - name: Run smoke tests
        run: |
          echo "üîç Running smoke tests..."
          # Check that the main services are responding.
          # In a real scenario, you would have a more comprehensive smoke test script.
          curl --fail http://localhost:3000 # Grafana
          curl --fail http://localhost:9090 # Prometheus
          curl --fail http://localhost:8080 # qBittorrent (through surfshark)
          echo "‚úÖ Smoke tests passed."

  # Send notification on success or failure
  notify:
    runs-on: ubuntu-latest
    needs: [smoke-test]
    if: always() # Always run this job
    steps:
      - name: Send Slack notification
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payload: |
            {
              "text": "Deployment to ${{ github.event.inputs.environment }} ${{ job.status }}. See details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
