################################################################################
# Traefik Dynamic Configuration - PotatoStack
# UFW Integration: Traefik is the ONLY public-facing service (ports 80/443)
# All other services are protected by UFW and accessible via Traefik only
################################################################################

http:
  middlewares:
    # CrowdSec IP blocking (integrated with UFW)
    crowdsec-bouncer:
      forwardAuth:
        address: http://crowdsec-traefik-bouncer:8080/api/v1/forwardAuth
        trustForwardHeader: true

    # Security headers (OWASP recommendations)
    security-headers:
      headers:
        customResponseHeaders:
          X-Robots-Tag: "noindex,nofollow,nosnippet,noarchive,notranslate,noimageindex"
          Server: "" # Hide server version
        sslRedirect: true
        stsSeconds: 31536000 # 1 year HSTS
        stsIncludeSubdomains: true
        stsPreload: true
        forceSTSHeader: true
        frameDeny: true
        contentTypeNosniff: true
        browserXssFilter: true
        referrerPolicy: "strict-origin-when-cross-origin"
        permissionsPolicy: "geolocation=(), microphone=(), camera=(), payment=()"
        customFrameOptionsValue: "SAMEORIGIN"

    # Rate limiting for public services
    rate-limit-public:
      rateLimit:
        average: 100
        period: 1s
        burst: 200

    # Rate limiting for API endpoints
    rate-limit-api:
      rateLimit:
        average: 50
        period: 1s
        burst: 100

    # Rate limiting for authentication
    rate-limit-auth:
      rateLimit:
        average: 10
        period: 1m
        burst: 20

    # Compression
    compress:
      compress: {}

    # Strip prefixes for path-based routing
    strip-prefix:
      stripPrefix:
        prefixes:
          - "/api"

    # Redirect to HTTPS (handled at entrypoint but available as middleware)
    redirect-https:
      redirectScheme:
        scheme: https
        permanent: true

    # Security chain for public services
    public-chain:
      chain:
        middlewares:
          - crowdsec-bouncer
          - security-headers
          - rate-limit-public
          - compress

    # Security chain for API services
    api-chain:
      chain:
        middlewares:
          - crowdsec-bouncer
          - security-headers
          - rate-limit-api
          - compress

    # Security chain for authenticated services (with SSO)
    auth-chain:
      chain:
        middlewares:
          - crowdsec-bouncer
          - security-headers
          - rate-limit-auth
          - compress

    # COOP/COEP headers for SharedArrayBuffer support (Actual Budget, etc.)
    # Required for WebAssembly and SharedArrayBuffer to work properly
    coop-coep-headers:
      headers:
        customResponseHeaders:
          Cross-Origin-Opener-Policy: "same-origin"
          Cross-Origin-Embedder-Policy: "require-corp"
          Cross-Origin-Resource-Policy: "same-origin"

    # Security chain for apps requiring SharedArrayBuffer (Actual Budget)
    shared-array-chain:
      chain:
        middlewares:
          - crowdsec-bouncer
          - coop-coep-headers
          - rate-limit-public
          - compress

tls:
  # Local self-signed certificates for *.danielhomelab.local
  # Generate with: ./scripts/setup/generate-local-certs.sh
  certificates:
    - certFile: /etc/traefik/certs/local.crt
      keyFile: /etc/traefik/certs/local.key
      stores:
        - default

  stores:
    default:
      defaultCertificate:
        certFile: /etc/traefik/certs/local.crt
        keyFile: /etc/traefik/certs/local.key

  options:
    default:
      minVersion: "VersionTLS12"
      maxVersion: "VersionTLS13"
      sniStrict: false  # Allow local domain without strict SNI
      cipherSuites:
        # TLS 1.3 cipher suites (recommended)
        - TLS_AES_128_GCM_SHA256
        - TLS_AES_256_GCM_SHA384
        - TLS_CHACHA20_POLY1305_SHA256
        # TLS 1.2 cipher suites (for compatibility)
        - TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256
        - TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256
        - TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384
        - TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384
        - TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305_SHA256
        - TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305_SHA256
      curvePreferences:
        - CurveP521
        - CurveP384
      alpnProtocols:
        - h2
        - http/1.1

################################################################################
# UFW Integration Notes:
#
# 1. Host-Level Firewall (UFW):
#    - Allows: SSH (22), HTTP (80), HTTPS (443), DNS (53)
#    - Denies: All other incoming connections
#    - Docker integration: ufw-docker manages container-specific rules
#
# 2. Traefik as Security Gateway:
#    - Only service with public ports (80/443)
#    - All HTTP traffic goes through Traefik
#    - CrowdSec blocks malicious IPs before reaching services
#    - SSL/TLS termination at Traefik level
#
# 3. Container-Level Security:
#    - All containers on internal potatostack network
#    - Most services bound to HOST_BIND (LAN-only)
#    - Traefik routes to internal services
#    - No direct external access to containers
#
# 4. Defense in Depth:
#    Layer 1: UFW (host firewall)
#    Layer 2: ufw-docker (container rules)
#    Layer 3: Traefik (reverse proxy + routing)
#    Layer 4: CrowdSec (IPS/threat intelligence)
#    Layer 5: Authentik (SSO/authentication)
#    Layer 6: OAuth2 Proxy (authorization)
#
# 5. Service Access Patterns:
#    - Public services: Internet → UFW → Traefik → Service
#    - LAN services: LAN → HOST_BIND → Service (bypasses Traefik)
#    - Internal: Container → Docker network → Service
#
################################################################################
