---
# Unified FileServer (Samba + SFTP + Filebrowser)
apiVersion: v1
kind: Service
metadata:
  name: fileserver
  namespace: potatostack
  labels:
    app: fileserver
spec:
  type: LoadBalancer
  ports:
  - port: 445
    name: smb
    protocol: TCP
  - port: 139
    name: netbios
    protocol: TCP
  - port: 22
    name: sftp
    protocol: TCP
  - port: 8087
    name: http
    protocol: TCP
  selector:
    app: fileserver
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: fileserver
  namespace: potatostack
  labels:
    app: fileserver
spec:
  replicas: 1
  selector:
    matchLabels:
      app: fileserver
  template:
    metadata:
      labels:
        app: fileserver
    spec:
      containers:
      - name: fileserver
        image: alpine:latest
        imagePullPolicy: IfNotPresent
        command:
        - sh
        - -c
        - |
          set -e
          echo '[FileServer] Installing packages...'
          apk add --no-cache samba samba-common-tools openssh-server wget

          echo '[FileServer] Configuring Samba...'
          mkdir -p /var/lib/samba /run/samba
          (echo "$SAMBA_PASSWORD"; echo "$SAMBA_PASSWORD") | smbpasswd -a -s $SAMBA_USER 2>/dev/null || adduser -D $SAMBA_USER && (echo "$SAMBA_PASSWORD"; echo "$SAMBA_PASSWORD") | smbpasswd -a -s $SAMBA_USER

          cat > /etc/samba/smb.conf <<'EOF'
          [global]
          workgroup = WORKGROUP
          server string = PotatoStack FileServer
          security = user
          map to guest = Bad User
          log level = 1

          [seconddrive]
          path = /data
          browseable = yes
          writable = yes
          valid users = files
          create mask = 0644
          directory mask = 0755
          EOF

          echo '[FileServer] Configuring SFTP...'
          ssh-keygen -A

          echo '[FileServer] Downloading Filebrowser...'
          wget -qO /tmp/filebrowser.tar.gz https://github.com/filebrowser/filebrowser/releases/download/v2.27.0/linux-arm64-filebrowser.tar.gz
          tar -xzf /tmp/filebrowser.tar.gz -C /usr/local/bin
          chmod +x /usr/local/bin/filebrowser

          echo '[FileServer] Starting services...'
          smbd -D --no-process-group
          nmbd -D
          /usr/sbin/sshd -D -e -p 22 &
          /usr/local/bin/filebrowser --address 0.0.0.0 --port 8087 --database /filebrowser-db/filebrowser.db --root /data &

          echo '[FileServer] All services running'
          wait
        env:
        - name: SAMBA_USER
          value: files
        - name: SAMBA_PASSWORD
          valueFrom:
            secretKeyRef:
              name: fileserver-credentials
              key: password
        - name: SFTP_USER
          value: files
        ports:
        - containerPort: 445
          name: smb
        - containerPort: 139
          name: netbios
        - containerPort: 22
          name: sftp
        - containerPort: 8087
          name: http
        volumeMounts:
        - name: data
          mountPath: /data
        - name: filebrowser-db
          mountPath: /filebrowser-db
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 750m
            memory: 192Mi
      volumes:
      - name: data
        hostPath:
          path: /mnt/seconddrive
      - name: filebrowser-db
        persistentVolumeClaim:
          claimName: filebrowser-db
