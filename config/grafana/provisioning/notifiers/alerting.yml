apiVersion: 1

contactPoints:
  - orgId: 1
    name: ntfy-default
    receivers:
      - uid: ntfy-receiver-default
        type: webhook
        settings:
          url: http://ntfy:80/${NTFY_TOPIC:-potatostack}
          httpMethod: POST
          username: ""
          password: ""
          title: "Grafana Alert: {{ .Status | toUpper }} - {{ .GroupLabels.alertname }}"
          message: |
            {{ range .Alerts }}
            **Alert**: {{ .Labels.alertname }}
            **Severity**: {{ .Labels.severity }}
            **Status**: {{ .Status }}
            {{ if .Annotations.summary }}**Summary**: {{ .Annotations.summary }}{{ end }}
            {{ if .Annotations.description }}**Description**: {{ .Annotations.description }}{{ end }}
            {{ if .Labels.instance }}**Instance**: {{ .Labels.instance }}{{ end }}
            **Started**: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
            {{ if .EndsAt.IsZero }}**Firing**{{ else }}**Resolved**{{ end }}

            ---
            {{ end }}
        secureSettings:
          # Authorization token for ntfy (optional)
          # password: "${NTFY_TOKEN}"

  - orgId: 1
    name: ntfy-critical
    receivers:
      - uid: ntfy-receiver-critical
        type: webhook
        settings:
          url: http://ntfy:80/${NTFY_TOPIC_CRITICAL:-potatostack-critical}
          httpMethod: POST
          username: ""
          password: ""
          title: "üö® CRITICAL Grafana Alert: {{ .Status | toUpper }} - {{ .GroupLabels.alertname }}"
          message: |
            {{ range .Alerts }}
            üö® **CRITICAL ALERT**

            **Alert**: {{ .Labels.alertname }}
            **Severity**: {{ .Labels.severity }}
            **Status**: {{ .Status }}
            {{ if .Annotations.summary }}**Summary**: {{ .Annotations.summary }}{{ end }}
            {{ if .Annotations.description }}**Description**: {{ .Annotations.description }}{{ end }}
            {{ if .Labels.instance }}**Instance**: {{ .Labels.instance }}{{ end }}
            {{ if .Labels.job }}**Job**: {{ .Labels.job }}{{ end }}
            **Started**: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
            {{ if .EndsAt.IsZero }}**FIRING - Immediate action required!**{{ else }}**RESOLVED**{{ end }}

            {{ if .Annotations.runbook }}**Runbook**: {{ .Annotations.runbook }}{{ end }}
            {{ end }}
        secureSettings:
          # Authorization token for ntfy (optional)
          # password: "${NTFY_TOKEN}"

  - orgId: 1
    name: ntfy-warning
    receivers:
      - uid: ntfy-receiver-warning
        type: webhook
        settings:
          url: http://ntfy:80/${NTFY_TOPIC_WARNING:-potatostack-warning}
          httpMethod: POST
          username: ""
          password: ""
          title: "‚ö†Ô∏è Warning Grafana Alert: {{ .Status | toUpper }} - {{ .GroupLabels.alertname }}"
          message: |
            {{ range .Alerts }}
            ‚ö†Ô∏è **WARNING ALERT**

            **Alert**: {{ .Labels.alertname }}
            **Severity**: {{ .Labels.severity }}
            **Status**: {{ .Status }}
            {{ if .Annotations.summary }}**Summary**: {{ .Annotations.summary }}{{ end }}
            {{ if .Annotations.description }}**Description**: {{ .Annotations.description }}{{ end }}
            {{ if .Labels.instance }}**Instance**: {{ .Labels.instance }}{{ end }}
            **Started**: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
            {{ if .EndsAt.IsZero }}**Warning - Attention needed**{{ else }}**Resolved**{{ end }}

            {{ end }}
        secureSettings:
          # Authorization token for ntfy (optional)
          # password: "${NTFY_TOKEN}"

muteTimes: []
policies:
  - orgId: 1
    receiver: ntfy-default
    group_by:
      - alertname
      - severity
      - job
    routes:
      - receiver: ntfy-critical
        match:
          severity: critical
        group_wait: 10s
        repeat_interval: 15m
        continue: true
      - receiver: ntfy-warning
        match:
          severity: warning
        group_wait: 1m
        repeat_interval: 6h
        continue: true
    group_wait: 30s
    group_interval: 10s
    repeat_interval: 12h
