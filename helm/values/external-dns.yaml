# external-dns - Automatic DNS management for Kubernetes
# Chart: external-dns/external-dns
# Automatically creates DNS records for Ingress/Service resources

# DNS Provider (choose one)
provider: cloudflare  # Options: cloudflare, aws, google, azure, etc.

# Cloudflare configuration
env:
  - name: CF_API_TOKEN
    valueFrom:
      secretKeyRef:
        name: cloudflare-api-token
        key: api-token
  # Or use API key + email:
  # - name: CF_API_KEY
  #   valueFrom:
  #     secretKeyRef:
  #       name: cloudflare-api-key
  #       key: api-key
  # - name: CF_API_EMAIL
  #   value: your-email@example.com

# Domain filter (only manage these domains)
domainFilters:
  - lepotato.local
  # Add your real domains:
  # - example.com
  # - example.org

# Only watch specific namespaces
namespaceFilter: ""  # Empty = all namespaces
# namespaceFilter: "potatostack,potatostack-monitoring"

# Sources to monitor
sources:
  - ingress
  - service
  # - istio-gateway
  # - crd

# Policy (sync or upsert-only)
policy: upsert-only  # Don't delete records, only create/update
# policy: sync  # Delete records when resources are removed

# Registry (track ownership of DNS records)
registry: txt
txtOwnerId: potatostack-k8s
txtPrefix: external-dns-

# Interval
interval: 1m

# Log level
logLevel: info
logFormat: json

# Resource limits (Le Potato optimized)
resources:
  requests:
    cpu: 50m
    memory: 64Mi
  limits:
    cpu: 200m
    memory: 128Mi

# Security context
securityContext:
  runAsNonRoot: true
  runAsUser: 65534
  fsGroup: 65534
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  capabilities:
    drop:
      - ALL
  seccompProfile:
    type: RuntimeDefault

# Service account
serviceAccount:
  create: true
  name: external-dns

# RBAC
rbac:
  create: true

# Metrics
metrics:
  enabled: true
  serviceMonitor:
    enabled: true
    additionalLabels:
      release: prometheus

# Node selector for ARM64
nodeSelector:
  kubernetes.io/arch: arm64

# Example: Create Cloudflare API token secret
# kubectl create secret generic cloudflare-api-token \
#   --from-literal=api-token=<YOUR_CLOUDFLARE_API_TOKEN> \
#   -n external-dns

# For AWS Route53:
# provider: aws
# env:
#   - name: AWS_ACCESS_KEY_ID
#     valueFrom:
#       secretKeyRef:
#         name: aws-credentials
#         key: access-key-id
#   - name: AWS_SECRET_ACCESS_KEY
#     valueFrom:
#       secretKeyRef:
#         name: aws-credentials
#         key: secret-access-key

# For local development (CoreDNS):
# provider: coredns
# extraArgs:
#   - --coredns-prefix=/skydns/
