################################################################################
# PotatoStack Light - Optimized for Le Potato (2GB RAM)
# Lean stack: VPN, file sync, backups, password manager
# Dual-disk caching, auto-healing, minimal footprint
################################################################################

x-logging: &default-logging
  driver: "json-file"
  options:
    max-size: "5m"
    max-file: "2"
    compress: "true"

services:
  ################################################################################
  # Storage Init - Creates required directories on startup
  ################################################################################
  storage-init:
    image: alpine:latest
    container_name: storage-init
    command: sh /init-storage.sh
    environment:
      - PUID=1000
      - PGID=1000
    volumes:
      - /mnt/storage:/mnt/storage
      - /mnt/cachehdd:/mnt/cachehdd
      - ./init-storage.sh:/init-storage.sh:ro
    network_mode: none
    restart: "no"
    labels:
      - "com.centurylinklabs.watchtower.enable=false"

  ################################################################################
  # Homepage - Unified Dashboard with All Widgets
  # Config files in ./homepage-config/ - edit and restart to apply changes
  # Access: http://HOST_BIND:3000 or http://SERVER_IP:3000 from LAN
  ################################################################################
  homepage:
    image: ghcr.io/gethomepage/homepage:${HOMEPAGE_TAG:-latest}
    container_name: homepage
    logging: *default-logging
    ports:
      - "${HOST_BIND}:3000:3000"
    environment:
      - TZ=Europe/Berlin
      - PUID=1000
      - PGID=1000
      - HOMEPAGE_VAR_HOST=${HOST_BIND}
      - HOMEPAGE_ALLOWED_HOSTS=192.168.178.40,${LAN_NETWORK:-192.168.178.0/24}
      - HOMEPAGE_VAR_TRANSMISSION_USER=${TRANSMISSION_USER}
      - HOMEPAGE_VAR_TRANSMISSION_PASS=${TRANSMISSION_PASSWORD}
      - HOMEPAGE_VAR_KOPIA_USER=${KOPIA_SERVER_USER}
      - HOMEPAGE_VAR_KOPIA_PASS=${KOPIA_SERVER_PASSWORD}
      - HOMEPAGE_VAR_SYNCTHING_KEY=${SYNCTHING_API_KEY}
      - HOMEPAGE_VAR_SLSKD_KEY=${SLSKD_API_KEY}
      - HOMEPAGE_VAR_PORTAINER_KEY=${PORTAINER_API_KEY}
    volumes:
      - ./homepage-config/settings.yaml:/app/config/settings.yaml:ro
      - ./homepage-config/services.yaml:/app/config/services.yaml:ro
      - ./homepage-config/widgets.yaml:/app/config/widgets.yaml:ro
      - ./homepage-config/bookmarks.yaml:/app/config/bookmarks.yaml:ro
      - ./homepage-config/docker.yaml:/app/config/docker.yaml:ro
      - ./homepage-config/custom.css:/app/config/custom.css:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - potatostack
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.3"
          memory: 96M
        reservations:
          memory: 48M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:3000"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "autoheal=true"

  ################################################################################
  # Watchtower - Automatic Container Updates
  ################################################################################
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    logging: *default-logging
    environment:
      - TZ=Europe/Berlin
      - DOCKER_API_VERSION=1.44
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_INCLUDE_RESTARTING=true
      - WATCHTOWER_INCLUDE_STOPPED=false
      - WATCHTOWER_REVIVE_STOPPED=false
      - WATCHTOWER_POLL_INTERVAL=86400
      - WATCHTOWER_ROLLING_RESTART=true
      - WATCHTOWER_TIMEOUT=300s
      - WATCHTOWER_SCHEDULE=0 0 3 * * *
      - WATCHTOWER_NOTIFICATIONS=shoutrrr
      - WATCHTOWER_NOTIFICATION_URL=${WATCHTOWER_NOTIFICATION_URL:-}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - potatostack
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.2"
          memory: 48M
        reservations:
          memory: 24M
    labels:
      - "com.centurylinklabs.watchtower.enable=false"

  ################################################################################
  # Autoheal - Automatic Container Recovery
  ################################################################################
  autoheal:
    image: willfarrell/autoheal:${AUTOHEAL_TAG:-latest}
    container_name: autoheal
    logging: *default-logging
    environment:
      - AUTOHEAL_CONTAINER_LABEL=autoheal
      - AUTOHEAL_INTERVAL=60
      - AUTOHEAL_START_PERIOD=300
      - AUTOHEAL_DEFAULT_STOP_TIMEOUT=10
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - potatostack
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.1"
          memory: 24M
        reservations:
          memory: 12M

  ################################################################################
  # Gluetun - VPN Client with Killswitch
  ################################################################################
  gluetun:
    image: qmcgaw/gluetun:${GLUETUN_TAG:-latest}
    container_name: gluetun
    logging: *default-logging
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - "${HOST_BIND}:8000:8000"
      - "${HOST_BIND}:9091:9091"
      - "${HOST_BIND}:51413:51413"
      - "${HOST_BIND}:51413:51413/udp"
      - "${HOST_BIND}:2234:2234"
      - "${HOST_BIND}:50000:50000"
    environment:
      - TZ=Europe/Berlin
      - VPN_SERVICE_PROVIDER=surfshark
      - VPN_TYPE=openvpn
      - OPENVPN_USER=${SURFSHARK_USER}
      - OPENVPN_PASSWORD=${SURFSHARK_PASSWORD}
      - OPENVPN_PROTOCOL=udp
      - SERVER_COUNTRIES=Germany
      - OPENVPN_VERBOSITY=0
      - OPENVPN_FLAGS=--tls-timeout 10 --connect-timeout 30 --connect-retry-max 3 --mssfix 1300
      - LOG_LEVEL=info
      - FIREWALL_OUTBOUND_SUBNETS=${LAN_NETWORK:-192.168.178.0/24}
      - FIREWALL_VPN_INPUT_PORTS=51413,50000
      - FIREWALL=on
      - DNS_ADDRESS=${VPN_DNS:-1.1.1.1}
      - DOT=off
      - HTTPPROXY=off
      - SHADOWSOCKS=off
      - HTTP_CONTROL_SERVER_ADDRESS=:8000
      - HTTP_CONTROL_SERVER_LOG=off
      - HTTP_CONTROL_SERVER_AUTH=off
      - IPV6=off
      - UPDATER_PERIOD=24h
      - HEALTH_VPN_DURATION_INITIAL=60s
      - HEALTH_VPN_DURATION_ADDITION=10s
    volumes:
      - gluetun-config:/gluetun
    networks:
      - potatostack
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.4"
          memory: 96M
        reservations:
          memory: 48M
    healthcheck:
      test: ["CMD", "pgrep", "openvpn"]
      interval: 120s
      timeout: 10s
      retries: 3
      start_period: 120s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "autoheal=true"

  ################################################################################
  # Transmission - Torrent Client (wired to Gluetun)
  ################################################################################
  transmission:
    image: lscr.io/linuxserver/transmission:${TRANSMISSION_TAG:-latest}
    container_name: transmission
    logging: *default-logging
    network_mode: "service:gluetun"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Berlin
      - USER=${TRANSMISSION_USER}
      - PASS=${TRANSMISSION_PASSWORD}
    volumes:
      - transmission-config:/config
      - /mnt/storage/downloads:/downloads
      - /mnt/cachehdd/transmission-incomplete:/incomplete
      - transmission-watch:/watch
    depends_on:
      storage-init:
        condition: service_completed_successfully
      gluetun:
        condition: service_healthy
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "autoheal=true"

  ################################################################################
  # slskd - Soulseek Client (wired to Gluetun)
  ################################################################################
  slskd:
    image: ghcr.io/slskd/slskd:${SLSKD_TAG:-latest}
    container_name: slskd
    logging: *default-logging
    network_mode: "service:gluetun"
    environment:
      - TZ=Europe/Berlin
      - SLSKD_HTTP_PORT=2234
      - SLSKD_SLSK_LISTEN_PORT=50000
      - SLSKD_USERNAME=${SLSKD_USER}
      - SLSKD_PASSWORD=${SLSKD_PASSWORD}
      - SLSKD_SOULSEEK_USERNAME=${SLSKD_SOULSEEK_USERNAME}
      - SLSKD_SOULSEEK_PASSWORD=${SLSKD_SOULSEEK_PASSWORD}
      - SLSKD_METRICS=false
    volumes:
      - slskd-config:/app
      - slskd-logs:/app/logs
      - /mnt/storage/slskd-shared:/var/slskd/shared
      - /mnt/cachehdd/slskd-incomplete:/var/slskd/incomplete
    depends_on:
      storage-init:
        condition: service_completed_successfully
      gluetun:
        condition: service_healthy
    restart: unless-stopped
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "autoheal=true"

  ################################################################################
  # Vaultwarden - Password Manager
  ################################################################################
  vaultwarden:
    image: vaultwarden/server:${VAULTWARDEN_TAG:-latest}
    container_name: vaultwarden
    logging: *default-logging
    ports:
      - "${HOST_BIND}:8080:80"
      - "${HOST_BIND}:3012:3012"
    environment:
      - TZ=Europe/Berlin
      - DOMAIN=https://vault.${HOST_DOMAIN:-lepotato.local}
      - ROCKET_PORT=80
      - WEBSOCKET_ENABLED=true
      - WEBSOCKET_PORT=3012
      - SIGNUPS_ALLOWED=${VAULTWARDEN_SIGNUPS_ALLOWED:-false}
      - INVITATIONS_ALLOWED=${VAULTWARDEN_INVITATIONS_ALLOWED:-true}
      - ADMIN_TOKEN=${VAULTWARDEN_ADMIN_TOKEN}
      - DATABASE_URL=/data/db.sqlite3
      - ICON_CACHE_TTL=2592000
      - ICON_CACHE_NEGTTL=259200
      - LOG_LEVEL=warn
      - EXTENDED_LOGGING=false
    volumes:
      - vaultwarden-data:/data
    networks:
      - potatostack
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.3"
          memory: 96M
        reservations:
          memory: 48M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:80/alive"]
      interval: 60s
      timeout: 10s
      retries: 5
      start_period: 30s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "autoheal=true"

  ################################################################################
  # Portainer - Container Management
  ################################################################################
  portainer:
    image: portainer/portainer-ce:${PORTAINER_TAG:-latest}
    container_name: portainer
    logging: *default-logging
    ports:
      - "${HOST_BIND}:9443:9443"
    environment:
      - TZ=Europe/Berlin
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer-data:/data
    networks:
      - potatostack
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.3"
          memory: 96M
        reservations:
          memory: 48M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:9000/api/system/status"]
      interval: 120s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "autoheal=true"
    profiles:
      - optional

  ################################################################################
  # Kopia - Backup Server
  ################################################################################
  kopia:
    image: kopia/kopia:${KOPIA_TAG:-latest}
    container_name: kopia
    logging: *default-logging
    hostname: kopia-server
    ports:
      - "${HOST_BIND}:51515:51515"
    environment:
      - TZ=Europe/Berlin
      - KOPIA_PASSWORD=${KOPIA_PASSWORD}
      - KOPIA_SERVER_USER=${KOPIA_SERVER_USER}
      - KOPIA_SERVER_PASSWORD=${KOPIA_SERVER_PASSWORD}
      - KOPIA_CONFIG_PATH=/app/config/repository.config
      - KOPIA_CACHE_DIRECTORY=/app/cache
      - KOPIA_LOG_DIR=/app/logs
    command:
      - server
      - start
      - --address=0.0.0.0:51515
      - --tls-generate-cert
      - --tls-generate-rsa-key-size=2048
      - --server-username=${KOPIA_SERVER_USER}
      - --server-password=${KOPIA_SERVER_PASSWORD}
      - --log-level=warn
      - --file-log-level=warn
      - --override-hostname=kopia-server
      - --override-username=all-users
    volumes:
      - /mnt/storage/kopia/repository:/repository
      - kopia-config:/app/config
      - /mnt/cachehdd/kopia-cache:/app/cache
      - kopia-logs:/app/logs
      - vaultwarden-data:/data/vaultwarden:ro
      # OneDrive mirror folders
      - /mnt/storage/syncthing/Desktop:/data/syncthing-Desktop:ro
      - /mnt/storage/syncthing/Obsidian-Vault:/data/syncthing-Obsidian-Vault:ro
      - /mnt/storage/syncthing/Bilder:/data/syncthing-Bilder:ro
      - /mnt/storage/syncthing/Dokumente:/data/syncthing-Dokumente:ro
      - /mnt/storage/syncthing/workdir:/data/syncthing-workdir:ro
      - /mnt/storage/syncthing/nvim:/data/syncthing-nvim:ro
      - /mnt/storage/syncthing/Microsoft-Copilot-Chat-Dateien:/data/syncthing-Microsoft-Copilot-Chat-Dateien:ro
      - /mnt/storage/syncthing/Attachments:/data/syncthing-Attachments:ro
      - /mnt/storage/syncthing/Privates:/data/syncthing-Privates:ro
      - /mnt/storage/syncthing/Studium:/data/syncthing-Studium:ro
      - /mnt/storage/syncthing/Berufliches:/data/syncthing-Berufliches:ro
      # Media folders
      - /mnt/storage/syncthing/camera-sync:/data/syncthing-camera-sync:ro
      - /mnt/storage/syncthing/photos:/data/syncthing-photos:ro
      - /mnt/storage/syncthing/videos:/data/syncthing-videos:ro
      - /mnt/storage/syncthing/music:/data/syncthing-music:ro
      - /mnt/storage/syncthing/audiobooks:/data/syncthing-audiobooks:ro
      - /mnt/storage/syncthing/podcasts:/data/syncthing-podcasts:ro
      - /mnt/storage/syncthing/books:/data/syncthing-books:ro
      - /mnt/storage/syncthing/shared:/data/syncthing-shared:ro
      - /mnt/storage/syncthing/backup:/data/syncthing-backup:ro
      # Download folders
      - /mnt/storage/downloads:/data/downloads:ro
      - /mnt/storage/slskd-shared:/data/slskd-shared:ro
    networks:
      - potatostack
    depends_on:
      storage-init:
        condition: service_completed_successfully
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.8"
          memory: 192M
        reservations:
          memory: 96M
    healthcheck:
      test: ["CMD", "curl", "-fk", "https://127.0.0.1:51515/api/v1/repo/status"]
      interval: 120s
      timeout: 20s
      retries: 3
      start_period: 60s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "autoheal=true"

  ################################################################################
  # Syncthing - P2P File Synchronization
  # Access: http://HOST_BIND:8384
  # Protocol: Decentralized, encrypted P2P sync
  # Full OneDrive mirror structure with ALL folders
  ################################################################################
  syncthing:
    image: lscr.io/linuxserver/syncthing:${SYNCTHING_TAG:-latest}
    container_name: syncthing
    logging: *default-logging
    hostname: ${SYNCTHING_HOSTNAME:-potatostack-sync}
    ports:
      - "${HOST_BIND}:8384:8384"
      - "${HOST_BIND}:22000:22000/tcp"
      - "${HOST_BIND}:22000:22000/udp"
      - "${HOST_BIND}:21027:21027/udp"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Berlin
      - UMASK=022
    volumes:
      - syncthing-config:/config
      # OneDrive mirror structure - ALL folders
      - /mnt/storage/syncthing/Desktop:/data/Desktop
      - /mnt/storage/syncthing/Obsidian-Vault:/data/Obsidian-Vault
      - /mnt/storage/syncthing/Bilder:/data/Bilder
      - /mnt/storage/syncthing/Dokumente:/data/Dokumente
      - /mnt/storage/syncthing/workdir:/data/workdir
      - /mnt/storage/syncthing/nvim:/data/nvim
      - /mnt/storage/syncthing/Microsoft-Copilot-Chat-Dateien:/data/Microsoft-Copilot-Chat-Dateien
      - /mnt/storage/syncthing/Attachments:/data/Attachments
      - /mnt/storage/syncthing/Privates:/data/Privates
      - /mnt/storage/syncthing/Studium:/data/Studium
      - /mnt/storage/syncthing/Berufliches:/data/Berufliches
      # Additional media folders
      - /mnt/storage/syncthing/camera-sync:/data/camera-sync
      - /mnt/storage/syncthing/photos:/data/photos
      - /mnt/storage/syncthing/videos:/data/videos
      - /mnt/storage/syncthing/music:/data/music
      - /mnt/storage/syncthing/audiobooks:/data/audiobooks
      - /mnt/storage/syncthing/podcasts:/data/podcasts
      - /mnt/storage/syncthing/books:/data/books
      - /mnt/storage/syncthing/shared:/data/shared
      - /mnt/storage/syncthing/backup:/data/backup
      # Symlinks to slskd and transmission (shared via Syncthing)
      - /mnt/storage/downloads:/data/downloads
      - /mnt/storage/slskd-shared:/data/slskd-shared
      # Cache HDD for file versioning (reduces main HDD writes)
      - /mnt/cachehdd/syncthing-versions:/data/.stversions
    networks:
      - potatostack
    depends_on:
      storage-init:
        condition: service_completed_successfully
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.8"
          memory: 384M
        reservations:
          memory: 192M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8384/rest/noauth/health"]
      interval: 120s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "autoheal=true"

  ################################################################################
  # FileBrowser - Web File Manager
  # Access: http://HOST_BIND:8181
  # Default credentials: admin/admin (change on first login!)
  # Full access to ALL storage folders
  ################################################################################
  filebrowser:
    image: filebrowser/filebrowser:${FILEBROWSER_TAG:-latest}
    container_name: filebrowser
    logging: *default-logging
    ports:
      - "${HOST_BIND}:8181:80"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Berlin
    volumes:
      - filebrowser-config:/config
      - filebrowser-database:/database
      - /mnt/storage:/srv/storage
      - /mnt/cachehdd:/srv/cachehdd
    networks:
      - potatostack
    depends_on:
      storage-init:
        condition: service_completed_successfully
    restart: unless-stopped
    deploy:
      resources:
        limits:
          cpus: "0.3"
          memory: 96M
        reservations:
          memory: 48M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:80/health"]
      interval: 120s
      timeout: 10s
      retries: 3
      start_period: 20s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "autoheal=true"

################################################################################
# Networks
################################################################################
networks:
  potatostack:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-potato
    ipam:
      config:
        - subnet: 172.21.0.0/16

################################################################################
# Volumes
################################################################################
volumes:
  # VPN & P2P
  gluetun-config:
  transmission-config:
  transmission-watch:
  slskd-config:
  slskd-logs:

  # Applications
  vaultwarden-data:
  portainer-data:
  syncthing-config:
  filebrowser-config:
  filebrowser-database:

  # Backup
  kopia-config:
  kopia-logs:
################################################################################
# Host Path Mounts - Single Disk Architectu
