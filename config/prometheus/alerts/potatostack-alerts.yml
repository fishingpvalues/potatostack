groups:
  - name: PotatoStack Infrastructure
    interval: 30s
    rules:
      # Labeled critical services missing (cadvisor)
      - alert: CriticalServiceMissing
        expr: time() - container_last_seen{container_label_potatostack_alerts="critical"} > 120
        for: 2m
        labels:
          severity: critical
          component: docker
        annotations:
          summary: "Critical service {{ $labels.container_label_com_docker_compose_service }} is down"
          description: "Service has not been seen by cAdvisor for more than 2 minutes"

      # Disk space low
      - alert: DiskSpaceLow
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 15
        for: 5m
        labels:
          severity: warning
          component: storage
        annotations:
          summary: "Low disk space on root partition"
          description: "Disk space is below 15% (current: {{ $value }}%)"

      # SMART disk health failing
      - alert: DiskSmartFailing
        expr: smartctl_device_smart_healthy == 0
        for: 10m
        labels:
          severity: critical
          component: storage
        annotations:
          summary: "Disk SMART health check failing"
          description: "One or more disks report SMART unhealthy status"

  - name: Application Health
    interval: 60s
    rules:
      # Gluetun container missing
      - alert: GluetunContainerMissing
        expr: time() - container_last_seen{container_label_com_docker_compose_service="gluetun"} > 120
        for: 2m
        labels:
          severity: critical
          component: vpn
        annotations:
          summary: "Gluetun container is missing"
          description: "cAdvisor has not seen gluetun for over 2 minutes"

      # Database connection issues
      - alert: PostgresDown
        expr: pg_up == 0
        for: 2m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "PostgreSQL is down"
          description: "PostgreSQL database has been down for more than 2 minutes"

      - alert: RedisDown
        expr: redis_up == 0
        for: 2m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "Redis is down"
          description: "Redis has been down for more than 2 minutes"

      - alert: MongoDown
        expr: mongodb_up == 0
        for: 2m
        labels:
          severity: critical
          component: database
        annotations:
          summary: "MongoDB is down"
          description: "MongoDB has been down for more than 2 minutes"
