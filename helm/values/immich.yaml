# Immich via bjw-s/app-template
# Two controllers: server and microservices

controllers:
  server:
    type: deployment
    replicas: 1
    containers:
      main:
        image:
          repository: ghcr.io/immich-app/immich-server
          tag: release
          pullPolicy: IfNotPresent
        env:
          - name: TZ
            value: Europe/Berlin
          - name: DB_HOSTNAME
            value: postgres
          - name: DB_DATABASE_NAME
            value: immich
          - name: DB_USERNAME
            value: immich
          - name: DB_PASSWORD
            valueFrom:
              secretKeyRef:
                name: immich-secrets
                key: IMMICH_DB_PASSWORD
          - name: REDIS_HOSTNAME
            value: redis
          - name: REDIS_PORT
            value: "6379"
          - name: REDIS_DBINDEX
            value: "2"
          - name: IMMICH_MACHINE_LEARNING_ENABLED
            value: "false"
          - name: UPLOAD_LOCATION
            value: /usr/src/app/upload
        probes:
          liveness:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /api/server-info/ping
                port: 3001
              initialDelaySeconds: 30
              periodSeconds: 30
          readiness:
            enabled: true
            custom: true
            spec:
              httpGet:
                path: /api/server-info/ping
                port: 3001
              initialDelaySeconds: 10
              periodSeconds: 15

  microservices:
    type: deployment
    replicas: 1
    containers:
      main:
        image:
          repository: ghcr.io/immich-app/immich-server
          tag: release
        command: ["start.sh", "microservices"]
        env:
          - name: TZ
            value: Europe/Berlin
          - name: DB_HOSTNAME
            value: postgres
          - name: DB_DATABASE_NAME
            value: immich
          - name: DB_USERNAME
            value: immich
          - name: DB_PASSWORD
            valueFrom:
              secretKeyRef:
                name: immich-secrets
                key: IMMICH_DB_PASSWORD
          - name: REDIS_HOSTNAME
            value: redis
          - name: REDIS_PORT
            value: "6379"
          - name: REDIS_DBINDEX
            value: "2"
          - name: IMMICH_MACHINE_LEARNING_ENABLED
            value: "false"

service:
  server:
    controller: server
    ports:
      http:
        port: 3001

ingress:
  server:
    enabled: true
    className: nginx
    hosts:
      - host: photos.lepotato.local
        paths:
          - path: /
            pathType: Prefix
            service:
              name: server
              port: http
    tls:
      - secretName: immich-tls
        hosts:
          - photos.lepotato.local

persistence:
  upload:
    enabled: true
    size: 10Gi
    accessMode: ReadWriteOnce
    mountPath: /usr/src/app/upload
    retain: true
  library:
    enabled: true
    size: 50Gi
    accessMode: ReadWriteOnce
    mountPath: /usr/src/app/library
    retain: true

resources:
  server:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 1
      memory: 512Mi
  microservices:
    requests:
      cpu: 200m
      memory: 192Mi
    limits:
      cpu: 1
      memory: 384Mi

