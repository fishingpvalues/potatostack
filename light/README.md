# PotatoStack Light

Production-ready Docker Compose stack for Le Potato with SOTA optimizations for 2GB RAM.

## Services

**VPN & P2P:** Gluetun (killswitch), Transmission, slskd
**Apps:** Vaultwarden, Portainer, Immich, Kopia, Seafile, Rustypaste, Homepage
**Infrastructure:** PostgreSQL, Redis, Watchtower, Autoheal
**Monitoring:** FritzBox Exporter

## Quick Start

### 1. Mount Storage
```bash
# Find UUIDs
sudo blkid

# Add to /etc/fstab
UUID=xxx /mnt/storage ext4 defaults,nofail 0 2
UUID=yyy /mnt/backup ext4 defaults,nofail 0 2

# Mount
sudo mkdir -p /mnt/storage /mnt/backup
sudo mount -a
```

### 2. Run Setup
```bash
cd light
chmod +x quick-start.sh
./quick-start.sh
```

**The script handles everything:**
- Directory structure
- System optimizations (swap, ZRAM, kernel tuning)
- Docker optimization
- Memory pressure handler
- Environment generation
- Cron jobs (backup, cleanup)
- Stack deployment

### 3. Access Services
Replace `HOST_IP` with your Le Potato IP:
- **Homepage**: http://HOST_IP:3000
- **Immich**: http://HOST_IP:2283
- **Portainer**: https://HOST_IP:9443
- **Vaultwarden**: http://HOST_IP:8080
- **Transmission**: http://HOST_IP:9091
- **Kopia**: https://HOST_IP:51515

## Optimizations for Le Potato (2GB RAM)

**Swap & Memory:**
- 4GB swap file on HDD (swappiness=10)
- ~1GB ZRAM compressed RAM (lz4, 50%)
- Memory pressure handler (restarts containers at 92% RAM)
- Kernel tuning (BBR TCP, aggressive writeback)

**Docker:**
- PostgreSQL: 128MB buffers, sync off, 50 connections
- Redis: 96MB limit, no persistence, lazy eviction
- Log limits: 10MB max, 3 files, compressed
- Concurrent ops limited to 3

**Monitoring:**
- Memory handler: `/var/log/memory-pressure.log`
- Cron logs: `/var/log/potatostack/`

Check status: `free -h && swapon --show`

## Automated Features

- **Watchtower**: Daily updates at 3 AM
- **Autoheal**: Self-healing unhealthy containers
- **Backup**: Nightly rsync to `/mnt/backup` (3 AM)
- **Cleanup**: Weekly docker prune (Sunday 4 AM)
- **Memory handler**: Auto-restarts at high memory

## Kopia Backup Server

Central backup server for all network devices at `https://HOST_IP:51515`.

**Connect devices:**
```bash
kopia repository connect server --url https://HOST_IP:51515
kopia snapshot create /path/to/backup
```

**Nightly backups:** Automatic rsync to `/mnt/backup` at 3 AM (7 day retention)

## Common Commands

```bash
# View logs
docker compose logs -f [service]

# Restart service
docker compose restart [service]

# Update stack (auto via Watchtower at 3 AM)
docker compose pull && docker compose up -d

# Stop stack
docker compose down

# Check memory
free -h && swapon --show

# View backup logs
tail -f /var/log/potatostack/backup.log
```

## Troubleshooting

**OOM / High Memory:**
```bash
free -h
tail /var/log/memory-pressure.log
docker stats --no-stream
```

**VPN Issues:**
```bash
docker compose logs gluetun
curl http://HOST_IP:8000/v1/publicip/ip
```

**Database Issues:**
```bash
docker compose exec postgres pg_isready -U postgres
docker compose logs immich-server --tail 50
```

**Permissions:**
```bash
sudo chown -R 1000:1000 /mnt/storage
docker compose restart [service]
```

## Security

- All services bind to HOST_IP (LAN-only)
- VPN killswitch for P2P (Transmission, slskd)
- Passwords auto-generated by quick-start.sh
- Store passwords in password manager
- Verify VPN: `curl http://HOST_IP:8000/v1/publicip/ip`
