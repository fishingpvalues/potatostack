name: Reusable Tests

on:
  workflow_call:

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - uses: pre-commit/action@v3.0.0

  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Trufflehog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          extra_args: --debug --only-verified

  docker-compose-config:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose
      - name: Validate docker-compose.yml
        run: docker-compose -f docker-compose.yml config

  opa-conftest:
    runs-on: ubuntu-latest
    needs: [pre-commit, secret-scan, docker-compose-config]
    steps:
      - uses: actions/checkout@v4
      - name: Install Conftest
        uses: instrumenta/conftest-action@v1.0.0
        with:
          version: 0.45.0
      - name: Run Conftest
        run: conftest test -p policy docker-compose.yml

  trivy-scan-images:
    runs-on: ubuntu-latest
    needs: [pre-commit, secret-scan, docker-compose-config, opa-conftest]
    steps:
    - uses: actions/checkout@v4
    - name: Install Trivy
      run: |
        sudo apt-get install wget apt-transport-https gnupg lsb-release -y
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install trivy -y
    - name: Scan images with Trivy
      run: |
        images=$(grep 'image:' docker-compose.yml | awk '{print $2}')
        for img in $images; do
          echo "Scanning image for vulnerabilities: $img"
          trivy image --exit-code 1 --severity HIGH,CRITICAL --no-progress "$img"
          echo "----------------------------------------"
        done

  license-scan:
    runs-on: ubuntu-latest
    needs: [pre-commit, secret-scan, docker-compose-config, opa-conftest]
    steps:
    - uses: actions/checkout@v4
    - name: Install Trivy
      run: |
        sudo apt-get install wget apt-transport-https gnupg lsb-release -y
        wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
        echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
        sudo apt-get update
        sudo apt-get install trivy -y
    - name: Scan images for licenses
      run: |
        images=$(grep 'image:' docker-compose.yml | awk '{print $2}')
        for img in $images; do
          echo "Scanning image for licenses: $img"
          trivy image --license-full --exit-code 0 --no-progress "$img"
          echo "----------------------------------------"
        done

  validate-deployment-scripts:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Install shellcheck
      run: sudo apt-get update && sudo apt-get install -y shellcheck
    - name: Validate bash scripts with shellcheck
      run: |
        echo "üîç Running shellcheck on all deployment scripts..."
        find . -type f -name "*.sh" | while read -r script; do
          echo "Checking: $script"
          shellcheck -x "$script"
        done
        echo "‚úÖ All bash scripts passed shellcheck validation"

  test-zfs-script-dry-run:
    runs-on: ubuntu-latest
    needs: [validate-deployment-scripts]
    steps:
    - uses: actions/checkout@v4
    - name: Test ZFS setup script (dry-run)
      run: |
        echo "üß™ Testing ZFS setup script in dry-run mode..."
        # Create a test version that doesn't actually run destructive commands
        cp 01-setup-zfs.sh 01-setup-zfs-test.sh

        # Check that the script has proper configuration variables
        if ! grep -q 'MAIN_DRIVE=' 01-setup-zfs.sh; then
          echo "‚ùå ERROR: MAIN_DRIVE variable not found in script"
          exit 1
        fi

        if ! grep -q 'CACHE_DRIVE=' 01-setup-zfs.sh; then
          echo "‚ùå ERROR: CACHE_DRIVE variable not found in script"
          exit 1
        fi

        if ! grep -q 'POOL_NAME=' 01-setup-zfs.sh; then
          echo "‚ùå ERROR: POOL_NAME variable not found in script"
          exit 1
        fi

        # Verify the script has safety checks
        if ! grep -q 'id -u' 01-setup-zfs.sh; then
          echo "‚ùå ERROR: Script missing root user check"
          exit 1
        fi

        if ! grep -q 'ERASE' 01-setup-zfs.sh; then
          echo "‚ùå ERROR: Script missing confirmation prompt"
          exit 1
        fi

        # Check for ZFS memory limit configuration
        if ! grep -q 'zfs_arc_max' 01-setup-zfs.sh; then
          echo "‚ùå ERROR: Script missing ZFS memory limit configuration"
          exit 1
        fi

        echo "‚úÖ ZFS setup script structure validated successfully"

  test-migration-script-dry-run:
    runs-on: ubuntu-latest
    needs: [validate-deployment-scripts]
    steps:
    - uses: actions/checkout@v4
    - name: Test migration script (dry-run)
      run: |
        echo "üß™ Testing migration script in dry-run mode..."

        # Check that the script has proper configuration
        if ! grep -q 'POOL_NAME=' 02-migrate-and-update-docker.sh; then
          echo "‚ùå ERROR: POOL_NAME variable not found in script"
          exit 1
        fi

        if ! grep -q 'MOUNT_POINT=' 02-migrate-and-update-docker.sh; then
          echo "‚ùå ERROR: MOUNT_POINT variable not found in script"
          exit 1
        fi

        # Verify the script creates backups
        if ! grep -q '.bak' 02-migrate-and-update-docker.sh; then
          echo "‚ùå ERROR: Script missing backup creation"
          exit 1
        fi

        # Verify the script has safety checks
        if ! grep -q 'id -u' 02-migrate-and-update-docker.sh; then
          echo "‚ùå ERROR: Script missing root user check"
          exit 1
        fi

        # Test the sed replacement logic (without modifying actual files)
        echo "Testing path replacement logic..."
        echo "/mnt/seconddrive/data" > test_path.txt
        sed 's|/mnt/seconddrive|/mnt/potatostack|g' test_path.txt | grep -q "/mnt/potatostack/data"
        if [ $? -eq 0 ]; then
          echo "‚úÖ Path replacement logic works correctly"
        else
          echo "‚ùå ERROR: Path replacement logic failed"
          exit 1
        fi

        echo "‚úÖ Migration script structure validated successfully"

  test-deploy-script:
    runs-on: ubuntu-latest
    needs: [validate-deployment-scripts]
    steps:
    - uses: actions/checkout@v4
    - name: Test deployment script structure
      run: |
        echo "üß™ Testing deployment script structure..."

        # Check if deploy.sh exists
        if [ ! -f "deploy.sh" ]; then
          echo "‚ùå ERROR: deploy.sh not found"
          exit 1
        fi

        # Verify the script has environment handling
        if ! grep -q 'staging\|production' deploy.sh; then
          echo "‚ö†Ô∏è  WARNING: Script may not properly handle staging/production environments"
        fi

        # Check for SSH configuration
        if ! grep -q 'ssh' deploy.sh; then
          echo "‚ö†Ô∏è  WARNING: Script may not have SSH deployment capability"
        fi

        echo "‚úÖ Deployment script structure validated"
