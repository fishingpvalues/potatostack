# Cilium Hubble - eBPF Network Observability (SOTA 2025)
# Optional: Advanced network monitoring with eBPF
# Requires ARM64 kernel 5.10+ with eBPF support
# Installation: helm install cilium cilium/cilium -f helm/values/cilium-hubble.yaml -n kube-system
#
# WARNING: This replaces Flannel CNI! Only install on fresh cluster or during migration.
# For Le Potato: Use as addon to existing CNI or install on fresh k3s with --flannel-backend=none

# Note: On Le Potato with existing Flannel, use Hubble in observability-only mode
# Full Cilium CNI replacement requires cluster rebuild

hubble:
  enabled: true
  relay:
    enabled: true
    replicas: 1
    resources:
      requests:
        memory: 64Mi
        cpu: 50m
      limits:
        memory: 128Mi
        cpu: 250m

  ui:
    enabled: true
    replicas: 1
    resources:
      requests:
        memory: 64Mi
        cpu: 50m
      limits:
        memory: 128Mi
        cpu: 250m

    ingress:
      enabled: true
      className: nginx
      hosts:
        - hubble.lepotato.local

  metrics:
    enabled:
      - dns
      - drop
      - tcp
      - flow
      - port-distribution
      - icmp
      - httpV2:exemplars=true;labelsContext=source_ip,source_namespace,source_workload,destination_ip,destination_namespace,destination_workload,traffic_direction

    serviceMonitor:
      enabled: true

# Cilium agent configuration (lightweight for ARM64)
agent:
  resources:
    requests:
      memory: 128Mi
      cpu: 100m
    limits:
      memory: 256Mi
      cpu: 500m

operator:
  replicas: 1
  resources:
    requests:
      memory: 64Mi
      cpu: 50m
    limits:
      memory: 128Mi
      cpu: 250m

# eBPF configuration
bpf:
  monitorAggregation: medium  # Reduce CPU usage
  preallocateMaps: false      # Save memory

# Use kube-proxy (hybrid mode for compatibility)
kubeProxyReplacement: "false"  # Set "true" for full eBPF datapath (requires cluster rebuild)

# Resource limits for Le Potato
resources:
  limits:
    memory: 256Mi
    cpu: 500m
  requests:
    memory: 128Mi
    cpu: 100m

# Enable only essential features to save resources
enableIPv4: true
enableIPv6: false
enableRuntimeDeviceDetection: true

# Observability features
prometheus:
  enabled: true
  serviceMonitor:
    enabled: true

# Policy enforcement (optional, costs CPU/memory)
policyEnforcementMode: "default"  # or "never" to disable and save resources
