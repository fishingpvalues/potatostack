name: Weekly Security & Drift Report

on:
  schedule:
    # Run every Monday at 9:00 UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  weekly-security-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate drift report
        id: drift
        run: |
          # Simple drift detection - count pinned versions
          total_services=$(grep -c "image:" docker-compose.yml)
          pinned_versions=$(grep "image:" docker-compose.yml | grep -v ":latest" | wc -l)

          echo "::set-output name=total_services::$total_services"
          echo "::set-output name=outdated_count::$pinned_versions"

          echo "Found $pinned_versions potentially outdated images out of $total_services total services"

      - name: Run Trivy vulnerability scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
          severity: 'HIGH,CRITICAL'

      - name: Upload Trivy results to Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Count vulnerabilities
        id: vuln
        run: |
          # Extract vulnerability counts from SARIF file
          if [ -f trivy-results.sarif ]; then
            critical_count=$(jq '.runs[0].results[]? | select(.level == "error") | .ruleId' trivy-results.sarif 2>/dev/null | wc -l || echo "0")
            high_count=$(jq '.runs[0].results[]? | select(.level == "warning") | .ruleId' trivy-results.sarif 2>/dev/null | wc -l || echo "0")
          else
            critical_count=0
            high_count=0
          fi

          echo "::set-output name=critical_cves::$critical_count"
          echo "::set-output name=high_cves::$high_count"

      - name: Create weekly report
        run: |
          cat > weekly-report.md << EOF
          # Weekly Security & Drift Report

          Generated on: $(date -u '+%Y-%m-%d %H:%M UTC')

          ## Summary

          - **Total Services**: ${{ steps.drift.outputs.total_services }}
          - **Potentially Outdated Images**: ${{ steps.drift.outputs.outdated_count }}
          - **Critical Vulnerabilities**: ${{ steps.vuln.outputs.critical_cves }}
          - **High Vulnerabilities**: ${{ steps.vuln.outputs.high_cves }}

          ## Recommendations

          $(if [ "${{ steps.vuln.outputs.critical_cves }}" -gt 0 ]; then echo "- ðŸš¨ **CRITICAL**: Address critical vulnerabilities immediately"; fi)
          $(if [ "${{ steps.vuln.outputs.high_cves }}" -gt 0 ]; then echo "- âš ï¸ **HIGH**: Review high-severity vulnerabilities"; fi)
          $(if [ "${{ steps.drift.outputs.outdated_count }}" -gt 0 ]; then echo "- ðŸ“¦ **DRIFT**: Consider updating pinned image versions"; fi)

          ## Next Steps

          1. Review the Security tab for detailed vulnerability information
          2. Check Renovate PRs for available updates
          3. Update base images and dependencies as needed
          4. Run full container image scans in CI/CD pipeline

          ---
          *This report is automatically generated weekly. Manual trigger available via workflow_dispatch.*
          EOF

      - name: Create or update GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportContent = fs.readFileSync('weekly-report.md', 'utf8');

            const criticalCves = ${{ steps.vuln.outputs.critical_cves }};
            const outdatedImages = ${{ steps.drift.outputs.outdated_count }};

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['weekly-report', 'security'],
              state: 'open'
            });

            const issueTitle = `Weekly Security & Drift Report - ${new Date().toISOString().split('T')[0]}`;

            const labels = ['weekly-report', 'security', 'automated'];
            if (criticalCves > 0) labels.push('critical');
            if (outdatedImages > 0) labels.push('drift');

            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                title: issueTitle,
                body: reportContent,
                labels: labels
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: reportContent,
                labels: labels
              });
            }

      - name: Upload report as artifact
        uses: actions/upload-artifact@v4
        with:
          name: weekly-security-report
          path: weekly-report.md