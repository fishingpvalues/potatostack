# Gluetun VPN pod with qBittorrent + slskd sidecars via bjw-s/app-template

controllers:
  main:
    type: deployment
    replicas: 1
    pod:
      securityContext:
        fsGroup: 1000
    containers:
      gluetun:
        image:
          repository: qmcgaw/gluetun
          tag: latest
        env:
          - name: TZ
            value: Europe/Berlin
          - name: VPN_SERVICE_PROVIDER
            value: surfshark
          - name: VPN_TYPE
            value: openvpn
          - name: OPENVPN_USER
            valueFrom:
              secretKeyRef:
                name: gluetun-secrets
                key: SURFSHARK_USER
          - name: OPENVPN_PASSWORD
            valueFrom:
              secretKeyRef:
                name: gluetun-secrets
                key: SURFSHARK_PASSWORD
          - name: SERVER_COUNTRIES
            value: Netherlands
          - name: SERVER_CITIES
            value: Amsterdam
          - name: FIREWALL_OUTBOUND_SUBNETS
            value: 192.168.178.0/24
          - name: FIREWALL_VPN_INPUT_PORTS
            value: "6881"
          - name: FIREWALL
            value: "on"
          - name: DNS_ADDRESS
            value: 1.1.1.1
          - name: DOT
            value: "off"
          - name: HTTPPROXY
            value: "off"
          - name: SHADOWSOCKS
            value: "off"
          - name: HTTP_CONTROL_SERVER_ADDRESS
            value: ":8000"
          - name: HTTP_CONTROL_SERVER_LOG
            value: "on"
          - name: IPV6
            value: "off"
        securityContext:
          capabilities:
            add: ["NET_ADMIN"]
          privileged: false
        resources:
          requests:
            cpu: 500m
            memory: 96Mi
          limits:
            cpu: 1
            memory: 128Mi

      qbittorrent:
        image:
          repository: lscr.io/linuxserver/qbittorrent
          tag: latest
        env:
          - name: PUID
            value: "1000"
          - name: PGID
            value: "1000"
          - name: TZ
            value: Europe/Berlin
          - name: WEBUI_PORT
            value: "8080"
          - name: TORRENTING_PORT
            value: "6881"
        resources:
          requests:
            cpu: 1
            memory: 256Mi
          limits:
            cpu: 1500m
            memory: 384Mi
        volumeMounts:
          - name: qb-config
            mountPath: /config
          - name: qb-downloads
            mountPath: /downloads
          - name: qb-incomplete
            mountPath: /incomplete

      slskd:
        image:
          repository: ghcr.io/slskd/slskd
          tag: latest
        env:
          - name: TZ
            value: Europe/Berlin
          - name: SLSKD_HTTP_PORT
            value: "2234"
          - name: SLSKD_SLSK_LISTEN_PORT
            value: "50000"
          - name: SLSKD_USERNAME
            valueFrom:
              secretKeyRef:
                name: slskd-secrets
                key: SLSKD_USER
          - name: SLSKD_PASSWORD
            valueFrom:
              secretKeyRef:
                name: slskd-secrets
                key: SLSKD_PASSWORD
          - name: SLSKD_METRICS
            value: "true"
          - name: SLSKD_METRICS_URL
            value: http://localhost:5031/metrics
        volumeMounts:
          - name: slskd-config
            mountPath: /app
          - name: slskd-logs
            mountPath: /app/logs
          - name: slskd-shared
            mountPath: /var/slskd/shared
          - name: slskd-incomplete
            mountPath: /var/slskd/incomplete

service:
  main:
    # Expose qBittorrent, slskd, and Gluetun control
    ports:
      qbittorrent:
        port: 8080
        targetPort: 8080
        protocol: TCP
      slskd:
        port: 2234
        targetPort: 2234
        protocol: TCP
      gluetun-http:
        port: 8000
        targetPort: 8000
        protocol: TCP
      bittorrent-tcp:
        port: 6881
        targetPort: 6881
        protocol: TCP
      bittorrent-udp:
        enabled: true
        port: 6881
        targetPort: 6881
        protocol: UDP

ingress:
  qbittorrent:
    enabled: true
    ingressClassName: nginx
    hosts:
      - host: torrents.lepotato.local
        paths:
          - path: /
            pathType: Prefix
            service:
              name: main
              port: qbittorrent
    tls:
      - secretName: qbittorrent-tls
        hosts: [torrents.lepotato.local]
  slskd:
    enabled: true
    ingressClassName: nginx
    hosts:
      - host: soulseek.lepotato.local
        paths:
          - path: /
            pathType: Prefix
            service:
              name: main
              port: slskd
    tls:
      - secretName: slskd-tls
        hosts: [soulseek.lepotato.local]

persistence:
  # Gluetun requires /dev/net/tun access
  dev-tun:
    enabled: true
    type: hostPath
    hostPath: /dev/net/tun
    advancedMounts:
      main:
        gluetun:
          - path: /dev/net/tun
  qb-config:
    enabled: true
    size: 1Gi
    accessMode: ReadWriteOnce
    advancedMounts:
      main:
        qbittorrent:
          - path: /config
  qb-downloads:
    enabled: true
    size: 50Gi
    accessMode: ReadWriteOnce
    advancedMounts:
      main:
        qbittorrent:
          - path: /downloads
  qb-incomplete:
    enabled: true
    size: 20Gi
    accessMode: ReadWriteOnce
    advancedMounts:
      main:
        qbittorrent:
          - path: /incomplete
  slskd-config:
    enabled: true
    size: 1Gi
    accessMode: ReadWriteOnce
  slskd-logs:
    enabled: true
    size: 1Gi
    accessMode: ReadWriteOnce
  slskd-shared:
    enabled: true
    size: 50Gi
    accessMode: ReadWriteOnce
  slskd-incomplete:
    enabled: true
    size: 20Gi
    accessMode: ReadWriteOnce

