# Docker Compose Test Override
# This file overrides volume mounts to use test-mounts/ instead of /mnt/
# AND relaxes security settings that prevent containers from functioning
# Use with: docker compose -f docker-compose.yml -f docker-compose.test.override.yml

services:
  # Security overrides - Remove overly strict cap_drop: ALL settings
  mariadb:
    cap_drop: []
    security_opt: []

  postgres:
    cap_drop: []
    security_opt: []

  redis:
    cap_drop: []
    security_opt: []
    read_only: false

  # nextcloud removed

  gitea:
    cap_drop: []
    security_opt: []
    volumes:
      - gitea_data:/data
      - ./test-mounts/seconddrive/gitea:/data/gitea/repositories
      - /etc/timezone:/etc/timezone:ro
      - /etc/localtime:/etc/localtime:ro

  loki:
    cap_drop: []
    read_only: false
    security_opt: []

  prometheus:
    cap_drop: []
    read_only: false
    security_opt: []

  grafana:
    cap_drop: []
    security_opt: []

  nginx-proxy-manager:
    cap_drop: []
    security_opt: []

  homepage:
    cap_drop: []
    security_opt: []
    volumes:
      - ./config/homepage:/app/config
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./test-mounts/seconddrive:/mnt/seconddrive:ro
      - ./test-mounts/cachehdd:/mnt/cachehdd:ro

  filebrowser:
    volumes:
      - ./test-mounts/seconddrive:/srv

  sftp:
    volumes:
      - ./test-mounts/seconddrive:/data

  samba:
    volumes:
      - ./test-mounts/seconddrive:/data

  seafile:
    volumes:
      - ./test-mounts/seconddrive/seafile:/shared

  portainer:
    cap_drop: []
    security_opt: []

  diun:
    cap_drop: []
    security_opt: []

  dozzle:
    cap_drop: []
    security_opt: []

  alertmanager:
    cap_drop: []
    read_only: false
    security_opt: []

  promtail:
    cap_drop: []
    security_opt: []
    volumes:
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - ./test-mounts/seconddrive/kopia/logs:/kopia-logs:ro
      - ./test-mounts/seconddrive/qbittorrent/config/logs:/qbittorrent-logs:ro
      - ./test-mounts/seconddrive/slskd/logs:/slskd-logs:ro
      - ./config/promtail:/etc/promtail
      - /var/lib/promtail:/var/lib/promtail

  autoheal:
    cap_drop: []
    security_opt: []

  node-exporter:
    cap_drop: []
    security_opt: []

  kopia:
    volumes:
      - ./test-mounts/seconddrive/kopia/repository:/repository
      - ./test-mounts/seconddrive/kopia/config:/app/config
      - ./test-mounts/seconddrive/kopia/cache:/app/cache
      - ./test-mounts/seconddrive/kopia/logs:/app/logs
      - ./test-mounts/seconddrive/kopia/tmp:/tmp
      - /:/host:ro

  db-backups:
    volumes:
      - ./test-mounts/seconddrive/backups/db:/backups

  vaultwarden-backup:
    volumes:
      - vaultwarden_data:/vaultwarden:ro
      - ./test-mounts/seconddrive/backups/vaultwarden:/backups

  # consolidated under db-backups

  qbittorrent:
    volumes:
      - ./test-mounts/seconddrive/qbittorrent/config:/config
      - ./test-mounts/cachehdd/torrents:/downloads
      - ./test-mounts/cachehdd/torrents/incomplete:/incomplete

  slskd:
    volumes:
      - ./test-mounts/seconddrive/slskd/config:/app
      - ./test-mounts/seconddrive/slskd/logs:/app/logs
      - ./test-mounts/cachehdd/soulseek:/var/slskd/shared
      - ./test-mounts/cachehdd/soulseek/incomplete:/var/slskd/incomplete

  uptime-kuma:
    volumes:
      - ./test-mounts/seconddrive/uptime-kuma:/app/data
      - /var/run/docker.sock:/var/run/docker.sock:ro

  immich-server:
    volumes:
      - ./test-mounts/seconddrive/immich/upload:/usr/src/app/upload
      - ./test-mounts/seconddrive/immich/library:/usr/src/app/library
      - /etc/localtime:/etc/localtime:ro

  immich-microservices:
    volumes:
      - ./test-mounts/seconddrive/immich/upload:/usr/src/app/upload
      - ./test-mounts/seconddrive/immich/library:/usr/src/app/library
      - /etc/localtime:/etc/localtime:ro

  # consolidated under db-backups

  netdata:
    volumes:
      - /etc/passwd:/host/etc/passwd:ro
      - /etc/group:/host/etc/group:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./test-mounts/seconddrive:/host/mnt/seconddrive:ro
      - ./test-mounts/cachehdd:/host/mnt/cachehdd:ro

  # Force smartctl-exporter to use amd64 platform (no ARM64 support)
  smartctl-exporter:
    platform: linux/amd64

  # Disable VPN services on macOS (no /dev/net/tun support)
  gluetun:
    profiles:
      - disabled
