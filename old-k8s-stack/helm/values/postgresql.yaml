# PostgreSQL (Bitnami) using pgvecto-rs image and init scripts

image:
  registry: docker.io
  repository: tensorchord/pgvecto-rs
  tag: pg14-v0.2.0

global:
  security:
    allowInsecureImages: true

primary:
  persistence:
    enabled: true
    size: 10Gi
  resources:
    requests:
      cpu: 200m
      memory: 192Mi
    limits:
      cpu: 1000m
      memory: 512Mi
  extraEnvVarsSecret: postgres-init-secrets
  initdb:
    user: postgres
    password: "" # taken from auth.existingSecret
    scripts:
      00-create-app-dbs.sql: |
        DO $$
        BEGIN
          IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'gitea') THEN
            EXECUTE format('CREATE ROLE gitea LOGIN PASSWORD %L', current_setting('GITEA_DB_PASSWORD', true));
          END IF;
          IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'gitea') THEN
            CREATE DATABASE gitea OWNER gitea;
          END IF;

          IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'immich') THEN
            EXECUTE format('CREATE ROLE immich LOGIN PASSWORD %L', current_setting('IMMICH_DB_PASSWORD', true));
          END IF;
          IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'immich') THEN
            CREATE DATABASE immich OWNER immich;
          END IF;

          IF NOT EXISTS (SELECT FROM pg_roles WHERE rolname = 'seafile') THEN
            EXECUTE format('CREATE ROLE seafile LOGIN PASSWORD %L', current_setting('SEAFILE_DB_PASSWORD', true));
          END IF;
          IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'ccnet_db') THEN
            CREATE DATABASE ccnet_db OWNER seafile;
          END IF;
          IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'seafile_db') THEN
            CREATE DATABASE seafile_db OWNER seafile;
          END IF;
          IF NOT EXISTS (SELECT FROM pg_database WHERE datname = 'seahub_db') THEN
            CREATE DATABASE seahub_db OWNER seafile;
          END IF;
        END
        $$;

      10-enable-vectors.sql: |
        \connect immich;
        CREATE EXTENSION IF NOT EXISTS vectors;

        \connect gitea;
        -- no extension required

        \connect seafile_db;
        -- no extension required

auth:
  enablePostgresUser: true
  existingSecret: postgres-auth-secret

fullnameOverride: postgres

service:
  ports:
    postgresql: 5432
