################################################################################
# PotatoStack Light - Enterprise-Grade Production Setup
# Single disk with nightly backup, automatic updates, self-healing
# 100% uptime focus with redundancy and network resilience
################################################################################

services:
  ################################################################################
  # Homepage - Unified Dashboard with All Widgets
  ################################################################################
  homepage:
    image: ghcr.io/gethomepage/homepage:${HOMEPAGE_TAG:-latest}
    container_name: homepage
    ports:
      - "${HOST_BIND}:3000:3000"
    environment:
      - TZ=Europe/Berlin
      - PUID=1000
      - PGID=1000
    volumes:
      - homepage-config:/app/config
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - potatostack
    restart: always
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 128M
        reservations:
          memory: 64M
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:3000"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "autoheal=true"

  ################################################################################
  # Watchtower - Automatic Container Updates
  ################################################################################
  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    environment:
      - TZ=Europe/Berlin
      - DOCKER_API_VERSION=1.44
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_INCLUDE_RESTARTING=true
      - WATCHTOWER_INCLUDE_STOPPED=false
      - WATCHTOWER_REVIVE_STOPPED=false
      - WATCHTOWER_POLL_INTERVAL=86400
      - WATCHTOWER_ROLLING_RESTART=true
      - WATCHTOWER_TIMEOUT=300s
      - WATCHTOWER_SCHEDULE=0 0 3 * * *
      - WATCHTOWER_NOTIFICATIONS=shoutrrr
      - WATCHTOWER_NOTIFICATION_URL=${WATCHTOWER_NOTIFICATION_URL:-}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - potatostack
    restart: always
    deploy:
      resources:
        limits:
          cpus: "0.25"
          memory: 64M
        reservations:
          memory: 32M
    labels:
      - "com.centurylinklabs.watchtower.enable=false"

  ################################################################################
  # Autoheal - Automatic Container Recovery
  ################################################################################
  autoheal:
    image: willfarrell/autoheal:${AUTOHEAL_TAG:-latest}
    container_name: autoheal
    environment:
      - AUTOHEAL_CONTAINER_LABEL=autoheal
      - AUTOHEAL_INTERVAL=30
      - AUTOHEAL_START_PERIOD=300
      - AUTOHEAL_DEFAULT_STOP_TIMEOUT=10
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - potatostack
    restart: always
    deploy:
      resources:
        limits:
          cpus: "0.1"
          memory: 32M
        reservations:
          memory: 16M

  ################################################################################
  # Gluetun - VPN Client with Killswitch
  ################################################################################
  gluetun:
    image: qmcgaw/gluetun:${GLUETUN_TAG:-latest}
    container_name: gluetun
    cap_add:
      - NET_ADMIN
    devices:
      - /dev/net/tun:/dev/net/tun
    ports:
      - "${HOST_BIND}:8000:8000"
      - "${HOST_BIND}:9091:9091"
      - "${HOST_BIND}:51413:51413"
      - "${HOST_BIND}:51413:51413/udp"
      - "${HOST_BIND}:2234:2234"
      - "${HOST_BIND}:50000:50000"
    environment:
      - TZ=Europe/Berlin
      - VPN_SERVICE_PROVIDER=surfshark
      - VPN_TYPE=${SURFSHARK_CONNECTION_TYPE:-openvpn}
      - OPENVPN_USER=${SURFSHARK_USER}
      - OPENVPN_PASSWORD=${SURFSHARK_PASSWORD}
      - SERVER_COUNTRIES=${SURFSHARK_COUNTRY:-Netherlands}
      - SERVER_CITIES=${SURFSHARK_CITY:-Amsterdam}
      - FIREWALL_OUTBOUND_SUBNETS=${LAN_NETWORK:-192.168.178.0/24}
      - FIREWALL_VPN_INPUT_PORTS=51413,50000
      - FIREWALL=on
      - DNS_ADDRESS=${VPN_DNS:-1.1.1.1}
      - DOT=off
      - HTTPPROXY=off
      - SHADOWSOCKS=off
      - HTTP_CONTROL_SERVER_ADDRESS=:8000
      - HTTP_CONTROL_SERVER_LOG=on
      - HTTP_CONTROL_SERVER_AUTH=off
      - IPV6=off
      - UPDATER_PERIOD=24h
    volumes:
      - gluetun-config:/gluetun
    networks:
      - potatostack
    restart: always
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 128M
        reservations:
          memory: 64M
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--spider",
          "-q",
          "http://127.0.0.1:8000/v1/publicip/ip",
        ]
      interval: 60s
      timeout: 10s
      retries: 5
      start_period: 30s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "autoheal=true"

  ################################################################################
  # Transmission - Torrent Client (wired to Gluetun)
  ################################################################################
  transmission:
    image: lscr.io/linuxserver/transmission:${TRANSMISSION_TAG:-latest}
    container_name: transmission
    network_mode: "service:gluetun"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Europe/Berlin
      - USER=${TRANSMISSION_USER}
      - PASS=${TRANSMISSION_PASSWORD}
    volumes:
      - transmission-config:/config
      - /mnt/storage/downloads:/downloads
      - /mnt/storage/transmission-incomplete:/incomplete
      - transmission-watch:/watch
    depends_on:
      gluetun:
        condition: service_healthy
    restart: always
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "autoheal=true"

  ################################################################################
  # slskd - Soulseek Client (wired to Gluetun)
  ################################################################################
  slskd:
    image: ghcr.io/slskd/slskd:${SLSKD_TAG:-latest}
    container_name: slskd
    network_mode: "service:gluetun"
    environment:
      - TZ=Europe/Berlin
      - SLSKD_HTTP_PORT=2234
      - SLSKD_SLSK_LISTEN_PORT=50000
      - SLSKD_USERNAME=${SLSKD_USER}
      - SLSKD_PASSWORD=${SLSKD_PASSWORD}
      - SLSKD_METRICS=false
    volumes:
      - slskd-config:/app
      - slskd-logs:/app/logs
      - /mnt/storage/slskd-shared:/var/slskd/shared
      - /mnt/storage/slskd-incomplete:/var/slskd/incomplete
    depends_on:
      gluetun:
        condition: service_healthy
    restart: always
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "autoheal=true"

  ################################################################################
  # PostgreSQL - Shared database
  ################################################################################
  postgres:
    image: tensorchord/pgvecto-rs:${POSTGRES_TAG:-pg14-v0.2.0}
    container_name: postgres
    command: postgres -c shared_buffers=128MB -c effective_cache_size=256MB -c work_mem=8MB -c max_connections=50 -c synchronous_commit=off -c random_page_cost=1.1
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_SUPER_PASSWORD}
      - POSTGRES_USER=postgres
      - POSTGRES_DB=postgres
      - IMMICH_DB_PASSWORD=${IMMICH_DB_PASSWORD}
      - SEAFILE_DB_PASSWORD=${SEAFILE_DB_PASSWORD}
      - TZ=Europe/Berlin
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./init-db.sh:/docker-entrypoint-initdb.d/00-init-db.sh:ro
    networks:
      - potatostack
    restart: always
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 384M
        reservations:
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "autoheal=true"

  ################################################################################
  # Redis - Shared cache
  ################################################################################
  redis:
    image: redis:${REDIS_TAG:-7-alpine}
    container_name: redis
    command: redis-server --maxmemory 96mb --maxmemory-policy allkeys-lru --save "" --appendonly no --lazyfree-lazy-eviction yes --activedefrag yes
    networks:
      - potatostack
    volumes:
      - redis-data:/data
    restart: always
    deploy:
      resources:
        limits:
          cpus: "0.3"
          memory: 128M
        reservations:
          memory: 96M
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "autoheal=true"

  ################################################################################
  # Immich - Photo Management (Server)
  ################################################################################
  immich-server:
    image: ghcr.io/immich-app/immich-server:${IMMICH_TAG:-release}
    container_name: immich-server
    entrypoint: ["/entrypoint-wrapper.sh"]
    command: ["start.sh", "immich"]
    ports:
      - "${HOST_BIND}:2283:3001"
    environment:
      - TZ=Europe/Berlin
      - DB_HOSTNAME=postgres
      - DB_DATABASE_NAME=immich
      - DB_USERNAME=immich
      - DB_PASSWORD=${IMMICH_DB_PASSWORD}
      - REDIS_HOSTNAME=redis
      - REDIS_PORT=6379
      - REDIS_DBINDEX=2
      - IMMICH_MACHINE_LEARNING_ENABLED=false
      - UPLOAD_LOCATION=/usr/src/app/upload
    volumes:
      - /mnt/storage/immich/upload:/usr/src/app/upload
      - /mnt/storage/immich/library:/usr/src/app/library
      - /mnt/storage/immich/thumbs:/usr/src/app/thumbs
      - ./immich-entrypoint.sh:/entrypoint-wrapper.sh:ro
    networks:
      - potatostack
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: always
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 384M
        reservations:
          memory: 256M
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--spider",
          "-q",
          "http://127.0.0.1:3001/api/server/ping",
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "autoheal=true"

  ################################################################################
  # Immich - Microservices
  ################################################################################
  immich-microservices:
    image: ghcr.io/immich-app/immich-server:${IMMICH_TAG:-release}
    container_name: immich-microservices
    entrypoint: ["/entrypoint-wrapper.sh"]
    command: ["start.sh", "microservices"]
    environment:
      - TZ=Europe/Berlin
      - DB_HOSTNAME=postgres
      - DB_DATABASE_NAME=immich
      - DB_USERNAME=immich
      - DB_PASSWORD=${IMMICH_DB_PASSWORD}
      - REDIS_HOSTNAME=redis
      - REDIS_PORT=6379
      - REDIS_DBINDEX=2
      - IMMICH_MACHINE_LEARNING_ENABLED=false
    volumes:
      - /mnt/storage/immich/upload:/usr/src/app/upload
      - /mnt/storage/immich/library:/usr/src/app/library
      - /mnt/storage/immich/thumbs:/usr/src/app/thumbs
      - ./immich-entrypoint.sh:/entrypoint-wrapper.sh:ro
    networks:
      - potatostack
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: always
    deploy:
      resources:
        limits:
          cpus: "0.75"
          memory: 256M
        reservations:
          memory: 128M
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "autoheal=true"

  ################################################################################
  # Vaultwarden - Password Manager
  ################################################################################
  vaultwarden:
    image: vaultwarden/server:${VAULTWARDEN_TAG:-latest}
    container_name: vaultwarden
    ports:
      - "${HOST_BIND}:8080:80"
      - "${HOST_BIND}:3012:3012"
    environment:
      - TZ=Europe/Berlin
      - DOMAIN=https://vault.${HOST_DOMAIN:-lepotato.local}
      - ROCKET_PORT=80
      - WEBSOCKET_ENABLED=true
      - WEBSOCKET_PORT=3012
      - SIGNUPS_ALLOWED=${VAULTWARDEN_SIGNUPS_ALLOWED:-false}
      - INVITATIONS_ALLOWED=${VAULTWARDEN_INVITATIONS_ALLOWED:-true}
      - ADMIN_TOKEN=${VAULTWARDEN_ADMIN_TOKEN}
      - DATABASE_URL=/data/db.sqlite3
      - ICON_CACHE_TTL=2592000
      - ICON_CACHE_NEGTTL=259200
      - LOG_LEVEL=info
      - EXTENDED_LOGGING=true
      - LOG_FILE=/data/vaultwarden.log
    volumes:
      - vaultwarden-data:/data
    networks:
      - potatostack
    restart: always
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 128M
        reservations:
          memory: 64M
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:80/alive"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "autoheal=true"

  ################################################################################
  # Portainer - Container Management
  ################################################################################
  portainer:
    image: portainer/portainer-ce:${PORTAINER_TAG:-latest}
    container_name: portainer
    ports:
      - "${HOST_BIND}:9443:9443"
      - "${HOST_BIND}:9000:9000"
    environment:
      - TZ=Europe/Berlin
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - portainer-data:/data
    networks:
      - potatostack
    restart: always
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 128M
        reservations:
          memory: 64M
    healthcheck:
      test:
        ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:9000/api/system/status"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 180s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "autoheal=true"

  ################################################################################
  # Kopia - Backup Server
  ################################################################################
  kopia:
    image: kopia/kopia:${KOPIA_TAG:-latest}
    container_name: kopia
    hostname: kopia-server
    ports:
      - "${HOST_BIND}:51515:51515"
      - "${HOST_BIND}:51516:51516"
    environment:
      - TZ=Europe/Berlin
      - KOPIA_PASSWORD=${KOPIA_PASSWORD}
      - KOPIA_SERVER_USER=${KOPIA_SERVER_USER}
      - KOPIA_SERVER_PASSWORD=${KOPIA_SERVER_PASSWORD}
      - KOPIA_CONFIG_PATH=/app/config/repository.config
      - KOPIA_CACHE_DIRECTORY=/app/cache
      - KOPIA_LOG_DIR=/app/logs
      - KOPIA_PROMETHEUS_ENABLED=true
      - KOPIA_PROMETHEUS_LISTEN_ADDR=:51516
    command:
      - server
      - start
      - --address=0.0.0.0:51515
      - --tls-generate-cert
      - --tls-generate-rsa-key-size=4096
      - --server-username=${KOPIA_SERVER_USER}
      - --server-password=${KOPIA_SERVER_PASSWORD}
      - --log-level=info
      - --file-log-level=debug
      - --metrics-listen-addr=:51516
      - --override-hostname=kopia-server
      - --override-username=all-users
    volumes:
      - /mnt/storage/kopia/repository:/repository
      - kopia-config:/app/config
      - /mnt/storage/kopia/cache:/app/cache
      - kopia-logs:/app/logs
      - vaultwarden-data:/data/vaultwarden:ro
      - /mnt/storage/immich/upload:/data/immich-upload:ro
      - /mnt/storage/immich/library:/data/immich-library:ro
      - /mnt/storage/seafile:/data/seafile:ro
      - /mnt/storage/downloads:/data/downloads:ro
      - /mnt/storage/slskd-shared:/data/slskd-shared:ro
    networks:
      - potatostack
    restart: always
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 256M
        reservations:
          memory: 128M
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--spider",
          "-q",
          "https://127.0.0.1:51515/api/v1/repo/status",
          "--no-check-certificate",
        ]
      interval: 60s
      timeout: 20s
      retries: 10
      start_period: 180s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "autoheal=true"

  ################################################################################
  # Seafile - File Sync & Share
  ################################################################################
  seafile:
    image: seafileltd/seafile-mc:${SEAFILE_TAG:-latest}
    container_name: seafile
    entrypoint: ["/entrypoint-wrapper.sh"]
    ports:
      - "${HOST_BIND}:8082:80"
    environment:
      - TZ=Europe/Berlin
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_USER=seafile
      - DB_PASSWORD=${SEAFILE_DB_PASSWORD}
      - CCNET_DB=ccnet_db
      - SEAFILE_DB=seafile_db
      - SEAHUB_DB=seahub_db
      - SEAFILE_ADMIN_EMAIL=${SEAFILE_ADMIN_EMAIL}
      - SEAFILE_ADMIN_PASSWORD=${SEAFILE_ADMIN_PASSWORD}
      - SEAFILE_SERVER_LETSENCRYPT=false
      - SEAFILE_SERVER_HOSTNAME=files.${HOST_DOMAIN:-lepotato.local}
      - TIME_ZONE=Europe/Berlin
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_DB=6
    volumes:
      - /mnt/storage/seafile:/shared
      - ./seafile-entrypoint.sh:/entrypoint-wrapper.sh:ro
    networks:
      - potatostack
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: always
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 384M
        reservations:
          memory: 256M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:80/api2/ping/"]
      interval: 30s
      timeout: 20s
      retries: 10
      start_period: 240s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "autoheal=true"

  ################################################################################
  # Rustypaste - Pastebin Service
  ################################################################################
  rustypaste:
    image: orhunp/rustypaste:${RUSTYPASTE_TAG:-latest}
    container_name: rustypaste
    ports:
      - "${HOST_BIND}:8001:8000"
    environment:
      - CONFIG=/config/config.toml
    volumes:
      - ./rustypaste-config.toml:/config/config.toml:ro
      - /mnt/storage/rustypaste:/var/lib/rustypaste
    networks:
      - potatostack
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:8000"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 60s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "autoheal=true"

  ################################################################################
  # FritzBox Exporter - Router Monitoring
  ################################################################################
  fritzbox-exporter:
    image: pdreker/fritz_exporter:${FRITZBOX_EXPORTER_TAG:-latest}
    container_name: fritzbox-exporter
    ports:
      - "${HOST_BIND}:9042:9042"
    environment:
      - TZ=Europe/Berlin
      - FRITZ_USERNAME=${FRITZ_USERNAME}
      - FRITZ_PASSWORD=${FRITZ_PASSWORD}
      - FRITZ_HOSTNAME=${FRITZ_HOSTNAME:-fritz.box}
      - FRITZ_PORT=${FRITZ_PORT:-49000}
      - FRITZ_PROTOCOL=${FRITZ_PROTOCOL:-https}
    networks:
      - potatostack
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://127.0.0.1:9042/metrics"]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 30s
    labels:
      - "com.centurylinklabs.watchtower.enable=true"
      - "autoheal=true"

################################################################################
# Networks
################################################################################
networks:
  potatostack:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: br-potato
    ipam:
      config:
        - subnet: 172.21.0.0/16

################################################################################
# Volumes
################################################################################
volumes:
  # Management tools
  homepage-config:

  # VPN & P2P
  gluetun-config:
  transmission-config:
  transmission-watch:
  slskd-config:
  slskd-logs:

  # Databases
  postgres-data:
  redis-data:

  # Applications
  vaultwarden-data:
  portainer-data:

  # Backup
  kopia-config:
  kopia-logs:
################################################################################
# Host Path Mounts - Single Disk Architectu
